---
- name: Create sdv namespace
  kubernetes.core.k8s:
    name: sdv
    api_version: v1
    kind: Namespace
    state: present

- name: Deploy Redis
  kubernetes.core.k8s:
    state: present
    definition: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: redis
        namespace: sdv
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: redis
        template:
          metadata:
            labels:
              app: redis
          spec:
            containers:
            - name: redis
              image: redis:latest
              ports:
              - containerPort: 6379
      ---
      apiVersion: v1
      kind: Service
      metadata:
        name: redis-service
        namespace: sdv
      spec:
        selector:
          app: redis
        ports:
          - protocol: TCP
            port: 6379
            targetPort: 6379

- name: Verify Redis pod is running
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: sdv
    label_selectors:
      - app=redis
  register: redis_pods
  until: redis_pods.resources | length > 0 and redis_pods.resources[0].status.containerStatuses[0].ready
  retries: 30
  delay: 10
