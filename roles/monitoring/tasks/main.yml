---
- name: Create node_exporter user
  ansible.builtin.user:
    name: node_exporter
    shell: /bin/false
    create_home: no
    state: present

- name: Download node_exporter
  ansible.builtin.get_url:
    url: https://github.com/prometheus/node_exporter/releases/download/v1.8.1/node_exporter-1.8.1.linux-amd64.tar.gz
    dest: /tmp/node_exporter-1.8.1.linux-amd64.tar.gz
    mode: '0644'

- name: Extract node_exporter
  ansible.builtin.unarchive:
    src: /tmp/node_exporter-1.8.1.linux-amd64.tar.gz
    dest: /tmp
    remote_src: yes

- name: Copy node_exporter binary
  ansible.builtin.copy:
    src: /tmp/node_exporter-1.8.1.linux-amd64/node_exporter
    dest: /usr/local/bin/node_exporter
    remote_src: yes
    mode: '0755'

- name: Create node_exporter systemd service file
  ansible.builtin.copy:
    content: |
      [Unit]
      Description=Node Exporter
      Wants=network-online.target
      After=network-online.target

      [Service]
      User=node_exporter
      Group=node_exporter
      Type=simple
      ExecStart=/usr/local/bin/node_exporter

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/node_exporter.service
    mode: '0644'
  notify:
    - Reload systemd
    - Start node_exporter

- name: Create monitoring namespace
  kubernetes.core.k8s:
    name: monitoring
    api_version: v1
    kind: Namespace
    state: present

- name: Deploy Prometheus Operator CRDs
  kubernetes.core.k8s:
    state: present
    src: "{{ item }}"
  loop:
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/example/prometheus-operator-crd/monitoring.coreos.com_alertmanagerconfigs.yaml
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/example/prometheus-operator-crd/monitoring.coreos.com_alertmanagers.yaml
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/example/prometheus-operator-crd/monitoring.coreos.com_podmonitors.yaml
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/example/prometheus-operator-crd/monitoring.coreos.com_probes.yaml
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/example/prometheus-operator-crd/monitoring.coreos.com_prometheuses.yaml
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/example/prometheus-operator-crd/monitoring.coreos.com_prometheusrules.yaml
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/example/prometheus-operator-crd/monitoring.coreos.com_servicemonitors.yaml
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/example/prometheus-operator-crd/monitoring.coreos.com_thanosrulers.yaml

- name: Deploy Prometheus Operator RBAC
  kubernetes.core.k8s:
    state: present
    src: "{{ item }}"
    namespace: monitoring
  loop:
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/example/rbac/prometheus-operator/prometheus-operator-service-accounts.yaml
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/example/rbac/prometheus-operator/prometheus-operator-cluster-roles.yaml
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/example/rbac/prometheus-operator/prometheus-operator-cluster-role-bindings.yaml
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/example/rbac/prometheus-operator/prometheus-operator-roles.yaml
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/example/rbac/prometheus-operator/prometheus-operator-role-bindings.yaml

- name: Deploy Prometheus Operator Deployment
  kubernetes.core.k8s:
    state: present
    src: https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/example/prometheus-operator-deployment.yaml
    namespace: monitoring

- name: Deploy Prometheus instance
  kubernetes.core.k8s:
    state: present
    src: "{{ item }}"
    namespace: monitoring
  loop:
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/example/prometheus-example-app/prometheus-example-app-deployment.yaml
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/example/prometheus-example-app/prometheus-example-app-service.yaml
    - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/example/prometheus-example-app/prometheus-example-app-servicemonitor.yaml

- name: Deploy Grafana
  kubernetes.core.k8s:
    state: present
    src: "{{ item }}"
    namespace: monitoring
  loop:
    - https://raw.githubusercontent.com/prometheus-operator/kube-prometheus/main/manifests/grafana-deployment.yaml
    - https://raw.githubusercontent.com/prometheus-operator/kube-prometheus/main/manifests/grafana-service.yaml

- name: Verify Node Exporter service status
  ansible.builtin.systemd_service:
    name: node_exporter
    state: started
    enabled: yes
  register: node_exporter_status
  failed_when: not node_exporter_status.status.ActiveState == "active"

- name: Verify monitoring stack pods are running
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: monitoring
    label_selectors:
      - app.kubernetes.io/name=prometheus
  register: prometheus_pods
  until: prometheus_pods.resources | length > 0 and prometheus_pods.resources[0].status.containerStatuses[0].ready
  retries: 30
  delay: 10

- name: Verify Grafana pods are running
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: monitoring
    label_selectors:
      - app.kubernetes.io/name=grafana
  register: grafana_pods
  until: grafana_pods.resources | length > 0 and grafana_pods.resources[0].status.containerStatuses[0].ready
  retries: 30
  delay: 10
